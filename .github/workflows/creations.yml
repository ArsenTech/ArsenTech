name: Generate Project List

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

jobs:
  build-list:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Set variables
        run: |
          echo "GH_USER=ArsenTech" >> $GITHUB_ENV
          echo "TARGET_FILE=README.md" >> $GITHUB_ENV
          echo "EXCLUDE_REPOS=ArsenTech,source-codes" >> $GITHUB_ENV

      - name: Generate list file
        run: |
          OUTPUT_FILE="generated.md"

          echo "#### Repositories" > "$OUTPUT_FILE"
          echo "" >> "$OUTPUT_FILE"

          # Convert exclusions to JSON array
          EXCLUDES=$(echo "$EXCLUDE_REPOS" | tr ',' '\n')

          curl -s "https://api.github.com/users/$GH_USER/repos?per_page=100" |
            jq -r --argjson excludes "$(printf '%s\n' $EXCLUDES | jq -R . | jq -s .)" '
              .[]
              | select(.archived == false)     # remove archived
              | select(.fork == false)         # remove forks
              | select(.name as $n | ($excludes | index($n)) | not)   # remove excluded names
              | "- [\(.name)](\(.html_url)) — ⭐ \(.stargazers_count)\n\(.description // \"No description\")"
            ' >> "$OUTPUT_FILE"

          echo "" >> "$OUTPUT_FILE"
          echo "#### Gists" >> "$OUTPUT_FILE"
          echo "" >> "$OUTPUT_FILE"

          curl -s "https://api.github.com/users/$GH_USER/gists?per_page=100" |
            jq -r '.[] | "- [\(.description // "Untitled gist")](\(.html_url))"' >> "$OUTPUT_FILE"

      - name: Replace content safely
        run: |
          START="<!-- CREATIONS:START -->"
          END="<!-- CREATIONS:END -->"

          sed -i "/$START/,/$END/{//!d;}" "$TARGET_FILE"
          sed -i "/$START/r generated.md" "$TARGET_FILE"

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git add "$TARGET_FILE"
          git commit -m "Updated project list"
          git push