name: Generate Project List

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * *"

jobs:
  build-list:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set variables
        run: |
          echo "GH_USER=ArsenTech" >> $GITHUB_ENV
          echo "TARGET_FILE=README.md" >> $GITHUB_ENV
          echo "EXCLUDE=ArsenTech|source-codes" >> $GITHUB_ENV

      - name: Generate list file
        run: |
          OUTPUT_FILE="generated.md"

          echo "#### Repositories" > "$OUTPUT_FILE"
          echo "" >> "$OUTPUT_FILE"

          curl -s "https://api.github.com/users/$GH_USER/repos?per_page=100" |
            jq -r '.[] | select(.archived == false) | "\(.name) \(.html_url)"' |
            grep -v -E "$EXCLUDE" |
            sed 's|^\([^ ]*\) \(.*\)$|- [\1](\2)|' >> "$OUTPUT_FILE"

          echo "" >> "$OUTPUT_FILE"
          echo "#### Gists" >> "$OUTPUT_FILE"
          echo "" >> "$OUTPUT_FILE"

          curl -s "https://api.github.com/users/$GH_USER/gists?per_page=100" |
            jq -r '.[] | "- [\(.description // "Untitled gist")](\(.html_url))"' >> "$OUTPUT_FILE"

      - name: Replace content safely
        run: |
          START="<!-- CREATIONS:START -->"
          END="<!-- CREATIONS:END -->"

          sed -i "/$START/,/$END/{//!d;}" "$TARGET_FILE"
          sed -i "/$START/r generated.md" "$TARGET_FILE"

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git add "$TARGET_FILE"
          git commit -m "Updated project list"
          git push